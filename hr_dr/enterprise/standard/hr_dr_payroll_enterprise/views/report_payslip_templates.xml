<?xml version="1.0" encoding="utf-8" ?>
<odoo>
  <data>
    <template id="external_layout_standard">
      <div t-attf-class="header o_company_#{company.id}_layout" t-att-style="report_header_style">
        <div class="row">
          <div class="col-3 mb4">
            <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" style="max-height: 45px;" alt="Logo"/>
          </div>
          <div class="col-9 text-end" style="margin-top:22px;" t-field="company.report_header" name="moto"/>
        </div>
        <div t-if="company.logo or company.report_header" class="row zero_min_height">
          <div class="col-12">
            <div style="border-bottom: 1px solid black;"/>
          </div>
        </div>
        <div class="row">
          <div class="col-6" name="company_address">
            <span t-if="company.company_details" t-field="company.company_details"></span>
            <span t-else="" t-field="company.partner_id"
                  t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": true}'/>
          </div>
        </div>
      </div>

      <div t-attf-class="article o_report_layout_standard o_company_#{company.id}_layout {{  'o_report_layout_background' if company.layout_background in ['Geometric', 'Custom']  else  '' }}" t-attf-style="background-image: url({{ 'data:image/png;base64,%s' % company.layout_background_image.decode('utf-8') if company.layout_background_image and company.layout_background == 'Custom' else '/base/static/img/bg_background_template.jpg' if company.layout_background == 'Geometric' else ''}});" t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id" t-att-data-oe-lang="o and o.env.context.get('lang')">
        <div class="pt-5">
          <!-- This div ensures that the address is not cropped by the header. -->
          <t t-call="web.address_layout"/>
        </div>
        <t t-out="0"/>
      </div>

      <div t-attf-class="footer o_standard_footer o_company_#{company.id}_layout">
        <div class="text-center" style="border-top: 1px solid black;">
          <ul class="list-inline mb4">
            <div t-field="company.report_footer"/>
          </ul>

          <div t-if="report_type == 'pdf'" class="text-muted">
            Page: <span class="page"/> / <span class="topage"/>
          </div>
        </div>
      </div>
    </template>

    <template id="external_layout">
      <t t-if="not o" t-set="o" t-value="doc"/>

      <t t-if="not company">
        <!-- Multicompany -->
        <t t-if="company_id">
          <t t-set="company" t-value="company_id"/>
        </t>
        <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
          <t t-set="company" t-value="o.company_id.sudo()"/>
        </t>
        <t t-else="else">
          <t t-set="company" t-value="res_company"/>
        </t>
      </t>
      <t t-else="else" t-call="hr_dr_payroll_enterprise.external_layout_standard"><t t-out="0"/></t>
    </template>

    <template id="payslip_layout">
      <div t-attf-class="article o_report_layout_standard o_company_#{company.id}_layout {{  'o_report_layout_background' if company.layout_background in ['Geometric', 'Custom']  else  '' }}"
           t-attf-style="background-image: url({{ 'data:image/png;base64,%s' % company.layout_background_image.decode('utf-8') if company.layout_background_image and company.layout_background == 'Custom' else '/base/static/img/bg_background_template.jpg' if company.layout_background == 'Geometric' else ''}}); margin=0; padding=0; max-height:100%; height=100%;"
           t-att-data-oe-model="o and o._name" t-att-data-oe-id="o and o.id" t-att-data-oe-lang="o and o.env.context.get('lang')">
<!--      <div style="margin=0; padding=0; max-height:99%; height=99%;">-->
        <div style="width=100%; max-height:50%; height:50%;">
          <t t-out="0"/>
        </div>
        <div style="border-bottom:dashed 1px gray;"/>
        <div style="width=100%; max-height:50%; height:50%;">
          <t t-out="0"/>
        </div>
      </div>
    </template>

    <template id="report_payslip_b">
      <t t-if="not o" t-set="o" t-value="doc"/>
      <t t-if="not company">
        <!-- Multicompany -->
        <t t-if="company_id">
          <t t-set="company" t-value="company_id"/>
        </t>
        <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
          <t t-set="company" t-value="o.company_id.sudo()"/>
        </t>
        <t t-else="else">
          <t t-set="company" t-value="res_company"/>
        </t>
      </t>

      <t t-call="hr_dr_payroll_enterprise.payslip_layout">
        <div class="page">
          <div class="row">
            <div class="col-3">
              <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" style="max-height: 45px;" alt="Logo"/>
            </div>
            <div class="col-9 text-center">
              COMPROBANTE DE ROL INDIVIDUAL
              <div t-esc="company.name"/>
              <div t-out="o.date_from" t-options="{'widget': 'date', 'format': 'MMMM-YYYY'}"/>
            </div>
          </div>
          <div class="row">
            <div class="col-1">NOMBRES</div>
            <div class="col-5 text-center me-1"><span t-field="o.employee_id"/></div>
            <div class="col-2 ms-1">FECHA DE PAGO</div>
            <div class="col-4 text-center">
              <t t-if="o.contract_id.date_end and o.date_to &gt; o.contract_id.date_end">
                <span t-field="o.contract_id.date_end"/>
              </t>
              <t t-else="">
                <span t-field="o.date_to"/>
              </t>
            </div>
          </div>
          <div class="row">
            <div class="col-1">CÉDULA</div>
            <div class="col-5 text-center me-1"><span t-field="o.employee_id.identification_id"/></div>
            <div class="col-2 ms-1">DÍAS TRABAJADOS</div>
            <div class="col-4 text-center"><span t-field="o.worked_days"/></div>
          </div>
          <div class="row mt-2 mb-1">
            <div class="col-6 me-1">INGRESOS</div>
            <div class="col-6 ms-1">DEDUCCIONES</div>
          </div>
          <div class="row">
            <div class="col-6 me-1">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th colspan="2" class="text-start">INGRESOS APORTABLES</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code == 'INGRESOS')" t-as="line">
                    <tr>
                      <td><span t-field="line.name"/></td>
                      <td class="text-end"><span t-field="line.total"/></td>
                    </tr>
                  </t>
                </tbody>
                <tfoot>
                    <tr>
                      <td>TOTAL INGRESOS APORTABLES</td>
                      <td class="text-end">
                        <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_INGRESOS_GBS')" t-as="line">
                          <span t-field="line.total"/>
                        </t>
                      </td>
                    </tr>
                </tfoot>
              </table>

              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th colspan="2" class="text-start">INGRESOS NO APORTABLES</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code == 'INGRESOS_NGBS')" t-as="line">
                    <tr>
                      <td><span t-field="line.name"/></td>
                      <td class="text-end"><span t-field="line.total"/></td>
                    </tr>
                  </t>
                </tbody>
                <tfoot>
                    <tr>
                      <td>TOTAL INGRESOS NO APORTABLES</td>
                      <td class="text-end">
                        <t t-foreach="o.line_ids.filtered(lambda line: line.code == 'SUBT_INGRESOS_NGBS')" t-as="line">
                          <span t-field="line.total"/>
                        </t>
                      </td>
                    </tr>
                </tfoot>
              </table>
            </div>

            <div class="col-6 ms-1">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code in ('EGRESOS', 'EGRESOS_PASIVOS'))" t-as="line">
                    <tr>
                      <td><span t-field="line.name"/></td>
                      <td class="text-end"><span t-field="line.total"/></td>
                    </tr>
                  </t>
                </tbody>
                <tfoot>
                    <tr>
                      <td></td>
                      <td></td>
                    </tr>
                </tfoot>
              </table>

              <div class="row">
                <div class="col-6">
                  TOTAL DESCUENTOS
                </div>
                <div class="col-6 text-end">
                  <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_EGRESOS')" t-as="line">
                    <span t-field="line.total"/>
                  </t>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-2 mb-5">
            <div class="col-2">
              TOTAL INGRESOS
            </div>
            <div class="col-4 text-end me-1">
              <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_TOTAL_INGRESOS')" t-as="line">
                <span t-field="line.total"/>
              </t>
            </div>

            <div class="col-2 ms-1">
              A RECIBIR
            </div>
            <div class="col-4 text-end">
              <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_NETO')" t-as="line">
                <span t-field="line.total"/>
              </t>
            </div>
          </div>

          <div class="row">
            <div class="col-6 border-top mx-3 text-center">
              TTHH
            </div>

            <div class="col-6 border-top mx-3 text-center">
              <span t-field="o.employee_id"/><br/>
              C.C. <span t-field="o.employee_id.identification_id"/>
            </div>
          </div>

        </div>
      </t>
    </template>

    <template id="report_payslip">
      <t t-if="not o" t-set="o" t-value="doc"/>

      <t t-if="not company">
        <!-- Multicompany -->
        <t t-if="company_id">
          <t t-set="company" t-value="company_id"/>
        </t>
        <t t-elif="o and 'company_id' in o and o.company_id.sudo()">
          <t t-set="company" t-value="o.company_id.sudo()"/>
        </t>
        <t t-else="else">
          <t t-set="company" t-value="res_company"/>
        </t>
      </t>

      <t t-call="hr_dr_payroll_enterprise.payslip_layout">
        <style>
          .page {
                    height: 6.7in;
                    max-height: 6.7in;
                    width: 100%;
                }
          * {
            font-size: 14px;
            font-family: sans-serif;
            font-weight: initial;
            text-transform: uppercase;
            margin: 0;
            padding: 0;
          }
          .table-sm th, .table-sm td {
            padding: 1px 3px;
          }

          .table-sm > :not(:first-child) {
            border-top: solid gray 1;
          }

          .s1 th, .s1 td {
            font-size: small;
          }

          .s2 th, .s2 td {
            font-size: x-small;
          }

          .s3 th, .s3 td {
            font-size: xx-small;
          }


          table.borderless, table.borderless td, table.borderless th, table.borderless tr {
            border-style: none;
          }

          table.borderless > :not(:first-child) {
            border-top: none;
          }
          .border-top {
            border-top: solid gray 1;
          }
          .mb-2 {
            margin-bottom: 10px;
          }
          .mt-1 {
            margin-top: 10px;
          }
          .mt-2 {
            margin-top: 20px;
          }
          .mt-4 {
            margin-top: 40px;
          }
          .mt-5 {
            margin-top: 50px;
          }
          .w-100 {
            width:100%;
          }
          .w-50 {
            width:50%;
          }
          .w-20 {
            width:20%;
          }
          .text-start {
            text-align: left;
          }
          .text-end {
            text-align: right;
          }
          .text-center {
            text-align: center;
          }
          .table {
            border-collapse: collapse;
            width: 100%;
          }
          .table-bordered td, .table-bordered th {
            margin: 0;
          }
          .p-header {
            vertical-align: top;
            height:12%;
          font-size:small;
          }
          .p-footer {
            vertical-align: bottom;
            height:14%;
            padding-top:auto;
            font-size:small;
          }
          .p-content {
            vertical-align:top;
            height:72%;
          }
        </style>
        <div class="page">
          <div class="p-header">
            <table class="table table-sm mt-2 borderless">
            <tr>
              <td class="w-20">
                <img t-if="company.logo" t-att-src="image_data_uri(company.logo)" style="max-height: 45px;" alt="Logo"/>
              </td>
              <td class="text-center">
                <strong>
                  COMPROBANTE DE ROL INDIVIDUAL
                </strong>
                <div t-esc="company.name"/>
                <div t-out="o.date_from" t-options="{'widget': 'date', 'format': 'MMMM-YYYY'}"/>
              </td>
            </tr>
          </table>
          </div>
          <div class="p-content">

            <t t-set="income_1" t-value="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code == 'INGRESOS')"/>
            <t t-set="income_2" t-value="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code == 'INGRESOS_NGBS')"/>
            <t t-set="expense" t-value="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.category_id.code in ('EGRESOS', 'EGRESOS_PASIVOS'))"/>

            <t t-set="left_rows" t-value="len(income_1) + len(income_2)"/>
            <t t-set="right_rows" t-value="len(expense)"/>

            <!-- Más de 18 líneas izq o 22 líneas der será un problema -->
            <t t-if="left_rows &gt; 15 or right_rows &gt; 18">
              <t t-set="text_size" t-value="s3"/>
            </t>
            <t t-elif="left_rows &gt; 11 or right_rows &gt; 14">
              <t t-set="text_size" t-value="s2"/>
            </t>
            <t t-elif="left_rows &gt; 8 or right_rows &gt; 11">
              <t t-set="text_size" t-value="s1"/>
            </t>
            <t t-else="">
              <t t-set="text_size" t-value=""/>
            </t>

            <table t-attf-class="'table table-sm borderless ' + text_size">
              <tr>
                <td style="width:10%;">NOMBRES</td>
                <td class="text-center" style="width:39%;"><span t-field="o.employee_id"/></td>
                <td style="width:2%;"></td>
                <td style="width:24%;">FECHA DE PAGO</td>
                <td class="text-center" style="width:25%;">
                  <t t-if="o.contract_id.date_end and o.date_to &gt; o.contract_id.date_end">
                    <span t-field="o.contract_id.date_end"/>
                  </t>
                  <t t-else="">
                    <span t-field="o.date_to"/>
                  </t>
                </td>
              </tr>
              <tr>
                <td>CÉDULA</td>
                <td class="text-center" ><span t-field="o.employee_id.identification_id"/></td>
                <td></td>
                <td>DÍAS TRABAJADOS</td>
                <td class="text-center" ><span t-field="o.worked_days"/></td>
              </tr>
              <tr>
                <td colspan="2"><br/>INGRESOS<br/></td>
                <td></td>
                <td colspan="2"><br/>DEDUCCIONES<br/></td>
              </tr>
              <tr>
                <td colspan="2" style="vertical-align:top;">
                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        <th colspan="2" class="text-start">INGRESOS APORTABLES</th>
                      </tr>
                    </thead>
                    <tbody>
                      <t t-foreach="income_1" t-as="line">
                        <tr>
                          <td><span t-field="line.name"/></td>
                          <td class="text-end w-20"><span t-field="line.total"/></td>
                        </tr>
                      </t>
                    </tbody>
                    <tfoot>
                        <tr>
                          <td>TOTAL INGRESOS APORTABLES</td>
                          <td class="text-end">
                            <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_INGRESOS_GBS')" t-as="line">
                              <span t-field="line.total"/>
                            </t>
                          </td>
                        </tr>
                    </tfoot>
                  </table>

                  <table class="table table-sm table-bordered mb-2">
                    <thead>
                      <tr>
                        <th colspan="2" class="text-start">INGRESOS NO APORTABLES</th>
                      </tr>
                    </thead>
                    <tbody>
                      <t t-foreach="income_2" t-as="line">
                        <tr>
                          <td><span t-field="line.name"/></td>
                          <td class="text-end w-20"><span t-field="line.total"/></td>
                        </tr>
                      </t>
                    </tbody>
                    <tfoot>
                        <tr>
                          <td>TOTAL INGRESOS NO APORTABLES</td>
                          <td class="text-end">
                            <t t-foreach="o.line_ids.filtered(lambda line: line.code == 'SUBT_INGRESOS_NGBS')" t-as="line">
                              <span t-field="line.total"/>
                            </t>
                          </td>
                        </tr>
                    </tfoot>
                  </table>
                </td>
                <td></td>
                <td colspan="2" style="vertical-align:top;">
                  <table class="table table-sm table-bordered mb-2">
  <!--                  <thead>-->
  <!--                    <tr>-->
  <!--                      <th></th>-->
  <!--                      <th></th>-->
  <!--                    </tr>-->
  <!--                  </thead>-->
                    <tbody>
                      <t t-foreach="expenses" t-as="line">
                        <tr>
                          <td><span t-field="line.name"/></td>
                          <td class="text-end w-20"><span t-field="line.total"/></td>
                        </tr>
                      </t>
                    </tbody>
  <!--                  <tfoot>-->
  <!--                      <tr>-->
  <!--                        <td></td>-->
  <!--                        <td></td>-->
  <!--                      </tr>-->
  <!--                  </tfoot>-->
                  </table>

                  <table class="table table-sm w-100">
                    <tr>
                      <td>TOTAL DESCUENTOS</td>
                      <td class="text-end w-20">
                        <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_EGRESOS')" t-as="line">
                          <span t-field="line.total"/>
                        </t>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                  <table class="w-100 table table-sm">
                    <tr>
                      <td>TOTAL INGRESOS</td>
                      <td class="text-end w-20">
                        <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_TOTAL_INGRESOS')" t-as="line">
                          <span t-field="line.total"/>
                        </t>
                      </td>
                    </tr>
                  </table>
                </td>
                <td></td>
                <td colspan="2">
                  <table class="w-100 table table-sm">
                    <tr>
                      <td>A RECIBIR</td>
                      <td class="text-end w-20">
                        <t t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip and line.code == 'SUBT_NETO')" t-as="line">
                          <span t-field="line.total"/>
                        </t>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </div>
          <div class="p-footer">
            <table class="table table-sm mt-5 borderless">
              <tr>
                <td class="border-top text-center" style="width:47%; vertical-align:top;">
                  TTHH
                </td>
                <td style="width:6%;"></td>
                <td class="border-top text-center" style="width:47%; vertical-align:top;">
                  <span t-field="o.employee_id"/><br/>
                  <span t-esc="'C.C. ' + o.employee_id.identification_id"/>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </t>
    </template>

    <template id="report_payslip_lang" inherit_id="hr_payroll.report_payslip_lang" priority="1">
      <xpath expr="//t[1]" position="replace">
        <t t-call="web.html_container">
          <t t-foreach="docs" t-as="o">
            <t t-set="o" t-value="o.with_context(lang=o.employee_id.sudo().address_home_id.lang or o.env.lang)"/>
            <t t-call="hr_dr_payroll_enterprise.report_payslip" t-lang="o.env.lang"/>
          </t>
        </t>
      </xpath>
    </template>

    <record id="payslip_paperformat" model="report.paperformat">
      <field name="name">Payslip A4</field>
      <field name="format">A4</field>
      <field name="page_height">0</field>
      <field name="page_width">0</field>
      <field name="orientation">Portrait</field>
      <field name="margin_top">7</field>
      <field name="margin_bottom">7</field>
      <field name="margin_left">7</field>
      <field name="margin_right">7</field>
      <field name="header_line" eval="False" />
      <field name="header_spacing">5</field>
      <field name="dpi">90</field>
    </record>

    <record id="hr_payroll.action_report_payslip" model="ir.actions.report">
      <field name="paperformat_id" ref="hr_dr_payroll_enterprise.payslip_paperformat"/>
      <field name="add_signature">True</field>
      <field name="y_coordinate">60</field>
      <field name="x_coordinate">30</field>
    </record>
  </data>
</odoo>